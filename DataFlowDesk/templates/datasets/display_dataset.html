{% extends "../base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header_title %}Case Study: Predicting Customer Churn{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <h2 class="text-3xl font-semibold text-gray-900 mb-4">{{ dataset.name }}</h2>
    <p class="text-lg text-gray-600 mb-6">{{ dataset.description }}</p>

    <!-- Dataset Table -->
    <div class="overflow-x-auto shadow-md rounded-lg bg-white mb-8">
        <table class="min-w-full table-auto text-left" id="dataset-table">
            <thead class="bg-gray-50 text-gray-700">
                <tr>
                    <th class="px-6 py-3 text-sm font-medium">ID</th>
                    {% for column in columns %}
                        <th class="px-6 py-3 text-sm font-medium">{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="text-sm text-gray-600" id="dataset-body">
                {% for row in dataset_data %}
                    <tr class="border-b hover:bg-gray-100">
                        <td class="px-6 py-3">{{ forloop.counter }}</td>
                        {% for value in row %}
                            <td class="px-6 py-3">{{ value }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

        <!-- "Show More" Button -->
        <div class="text-center">
            <button id="show-more-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                Show More
            </button>
        </div>
    
        <!-- Dataset Stats -->
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Dataset Statistics</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for stat, values in stats.items %}
                    <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                        <h4 class="text-lg font-medium text-gray-800">{{ stat|title }}</h4>
                        <ul class="text-sm text-gray-600">
                            {% for key, value in values.items %}
                                <li>{{ key|title }}: {{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endfor %}
            </div>
        </div>
    
        <!-- Graph Display -->
        <div class="mb-8">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Dataset Graph</h3>
            <div class="bg-white p-6 rounded-lg shadow-md">
                {{ graph_html|safe }}  <!-- Render the Plotly graph -->
            </div>
        </div>

    <!-- Clean Data Button -->
    <div class="mt-6 text-center">
        <button id="clean-data-btn" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all">
            Clean Data
        </button>
    </div>

    <!-- Clean Data Popup -->
    <div id="clean-data-popup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-lg w-11/12 md:w-2/3 lg:w-1/2">
            <h3 class="text-2xl font-semibold text-gray-900 mb-4">Data Cleaning & Preprocessing</h3>
            <ul id="cleaning-tasks" class="text-sm text-gray-700 mb-6">
                <!-- Tasks will be dynamically populated -->
            </ul>
            <div class="text-center">
                <button id="proceed-cleaning-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
                    Proceed
                </button>
                <button id="close-popup-btn" class="ml-4 px-6 py-3 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 transition-all">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Show popup when "Clean Data" button is clicked
    document.getElementById('clean-data-btn').addEventListener('click', function () {
        fetch("{% url 'data_cleaning_preview' dataset.id %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Populate cleaning tasks
            const tasksList = document.getElementById('cleaning-tasks');
            const proceedButton = document.getElementById('proceed-cleaning-btn');

            tasksList.innerHTML = ''; // Clear previous tasks
            data.tasks.forEach(task => {
                const li = document.createElement('li');
                li.textContent = task;
                tasksList.appendChild(li);
            });

            // Check if the only task is "Dataset already processed"
            if (data.tasks.length === 1 && data.tasks[0] === "Dataset already processed") {
                // Disable the proceed button if already processed
                proceedButton.disabled = true;
                proceedButton.title = "Cleaning cannot proceed because the dataset is already processed.";
                proceedButton.style.backgroundColor = 'grey';
                proceedButton.style.cursor = 'not-allowed';
            } else {
                // Enable the proceed button otherwise
                proceedButton.disabled = false;
                proceedButton.title = ""; // Remove any title
            }

            // Show the popup
            document.getElementById('clean-data-popup').classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error fetching cleaning tasks:', error);
            alert('An error occurred while fetching cleaning tasks.');
        });
    });

    // Proceed with cleaning when "Proceed" button is clicked
    document.getElementById('proceed-cleaning-btn').addEventListener('click', function () {
        // Ask the user if they want to remove the first row
        const removeFirstRow = confirm("Do you want to remove the first row of the dataset?");

        // Proceed with data cleaning
        fetch("{% url 'perform_data_cleaning' dataset.id %}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
            remove_first_row: removeFirstRow // Send user's choice
            }),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // Show a success message
                document.getElementById('clean-data-popup').classList.add('hidden'); // Close the popup
                location.reload(); // Reload the page to show cleaned data
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during data cleaning.');
            });
    });

    // Close the popup
    document.getElementById('close-popup-btn').addEventListener('click', function () {
        document.getElementById('clean-data-popup').classList.add('hidden');
    });

    // JavaScript for "Show More" Button
    var displayedRows = 5;  // Initial number of rows displayed

    document.getElementById('show-more-btn').addEventListener('click', function() {
        fetch("{% url 'display_dataset' dataset.id %}?displayed_rows=" + displayedRows, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            // Get the next 5 rows from the response
            var nextRows = data.next_rows;
            var tbody = document.getElementById('dataset-body');
            
            // Loop through the next rows and add them to the table
            nextRows.forEach(function(row, index) {
                var tr = document.createElement('tr');
                tr.classList.add('border-b', 'hover:bg-gray-100');

                // Add the ID column (index + 1 for 1-based index)
                var td = document.createElement('td');
                td.classList.add('px-6', 'py-3');
                td.textContent = displayedRows + index + 1;  // Start from the next row
                tr.appendChild(td);

                // Add the rest of the data columns
                row.forEach(function(value) {
                    var td = document.createElement('td');
                    td.classList.add('px-6', 'py-3');
                    td.textContent = value;
                    tr.appendChild(td);
                });

                // Append the row to the table body
                tbody.appendChild(tr);
            });

            // Update the number of displayed rows
            displayedRows += 5;

            // If there are no more rows to display, hide the "Show More" button
            if (nextRows.length < 5) {
                document.getElementById('show-more-btn').style.display = 'none';
            }
        });
    });
</script>
{% endblock %}
