{% extends "../base.html" %}

{% block title %}Dashboard{% endblock %}

{% block header_title %}Case Study: Predicting Customer Churn{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <h2 class="text-3xl font-semibold text-gray-900 mb-4">{{ dataset.name }}</h2>
    <p class="text-lg text-gray-600 mb-6">{{ dataset.description }}</p>

    <!-- Dataset Table -->
    <div class="overflow-x-auto shadow-md rounded-lg bg-white mb-8">
        <table class="min-w-full table-auto text-left" id="dataset-table">
            <thead class="bg-gray-50 text-gray-700">
                <tr>
                    <th class="px-6 py-3 text-sm font-medium">ID</th>
                    {% for column in columns %}
                        <th class="px-6 py-3 text-sm font-medium">{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody class="text-sm text-gray-600" id="dataset-body">
                {% for row in dataset_data %}
                    <tr class="border-b hover:bg-gray-100">
                        <td class="px-6 py-3">{{ forloop.counter }}</td>
                        {% for value in row %}
                            <td class="px-6 py-3">{{ value }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- "Show More" Button -->
    <div class="text-center">
        <button id="show-more-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            Show More
        </button>
    </div>

    <!-- Dataset Stats -->
    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
        <h3 class="text-2xl font-semibold text-gray-900 mb-4">Dataset Statistics</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for stat, values in stats.items %}
                <div class="bg-gray-50 p-4 rounded-lg shadow-md">
                    <h4 class="text-lg font-medium text-gray-800">{{ stat|title }}</h4>
                    <ul class="text-sm text-gray-600">
                        {% for key, value in values.items %}
                            <li>{{ key|title }}: {{ value }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        </div>
    </div>


    <!-- "Create Graphs" Button -->
    <div class="text-center">
        <a href="{% url 'display_graphs' dataset.id %}" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 transition-all">
            Create Graphs
        </a>
    </div>


    <!-- Clean Data Button -->
    <div class="mt-6 text-center">
        <button id="clean-data-btn" class="px-6 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all">
            Clean Data
        </button>
    </div>





    <!-- Normalize Data Button -->
    <div class="mt-6 text-center">
        <button id="normalize-data-btn" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 transition-all">
            Normalize Data
        </button>
    </div>

</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>

    // JavaScript for "Clean Data" Popup and Proceed Button
    document.getElementById('clean-data-btn').addEventListener('click', function () {
        fetch("{% url 'data_cleaning_preview' dataset.id %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                const tasksList = document.getElementById('cleaning-tasks');
                const proceedButton = document.getElementById('proceed-cleaning-btn');

                tasksList.innerHTML = '';
                data.tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.textContent = task;
                    tasksList.appendChild(li);
                });

                document.getElementById('clean-data-popup').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error fetching cleaning tasks:', error);
                alert('An error occurred while fetching cleaning tasks.');
            });
    });

    document.getElementById('proceed-cleaning-btn').addEventListener('click', function () {
        const removeFirstRow = confirm("Do you want to remove the first row of the dataset?");
        
        const data = JSON.stringify({
            remove_first_row: removeFirstRow
        });

        fetch("{% url 'perform_data_cleaning' dataset.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: data
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('An error occurred during data cleaning.');
                }
            })
            .catch(error => {
                console.error('Error cleaning data:', error);
                alert('An error occurred during data cleaning.');
            });
    });

    document.getElementById('close-popup-btn').addEventListener('click', function () {
        document.getElementById('clean-data-popup').classList.add('hidden');
    });




    // JavaScript for "Show More" Button
    let displayedRows = 5;

    document.getElementById('show-more-btn').addEventListener('click', function () {
        fetch("{% url 'display_dataset' dataset.id %}?displayed_rows=" + displayedRows, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
            .then(response => response.json())
            .then(data => {
                const nextRows = data.next_rows;
                const tbody = document.getElementById('dataset-body');

                nextRows.forEach(function (row, index) {
                    const tr = document.createElement('tr');
                    tr.classList.add('border-b', 'hover:bg-gray-100');

                    const td = document.createElement('td');
                    td.classList.add('px-6', 'py-3');
                    td.textContent = displayedRows + index + 1;
                    tr.appendChild(td);

                    row.forEach(function (value) {
                        const td = document.createElement('td');
                        td.classList.add('px-6', 'py-3');
                        td.textContent = value;
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });

                displayedRows += 5;

                if (nextRows.length < 5) {
                    document.getElementById('show-more-btn').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error fetching additional rows:', error);
                alert('An error occurred while fetching more rows.');
            });
    });

    // JavaScript for "Normalize Data" Popup
    document.getElementById('normalize-data-btn').addEventListener('click', function () {
        document.getElementById('normalize-data-popup').classList.remove('hidden');
    });

    document.getElementById('close-normalization-popup-btn').addEventListener('click', function () {
        document.getElementById('normalize-data-popup').classList.add('hidden');
    });

    document.getElementById('proceed-normalization-btn').addEventListener('click', function () {
        fetch("{% url 'perform_data_normalization' dataset.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('An error occurred during data normalization.');
                }
            })
            .catch(error => {
                console.error('Error normalizing data:', error);
                alert('An error occurred during data normalization.');
            });
    });
</script>

{% endblock %}
